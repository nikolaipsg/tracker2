
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Training Tracker</title>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="/icons/icon-512.png"/>
  <style>
    :root{ color-scheme: light dark; --tint:#0ea5e9; --bg:#f2f2f7; --card:#ffffff; --label:#111827; --secondary:rgba(60,60,67,0.6); --separator:rgba(60,60,67,0.29); --hairline:rgba(0,0,0,0.08); --shadow:0 10px 30px rgba(0,0,0,.07); --surface-translucent:rgba(255,255,255,0.85); }
    @media (prefers-color-scheme: dark){ :root{ --bg:#000; --card:#1c1c1e; --label:#f2f2f7; --secondary:rgba(235,235,245,0.6); --separator:rgba(84,84,88,0.65); --hairline:rgba(255,255,255,0.08); --shadow:0 10px 30px rgba(0,0,0,.75); --surface-translucent:rgba(28,28,30,0.85); }}
    html,body,#root{height:100%}
    body{margin:0;background:var(--bg);color:var(--label);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans";-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}
    .nav{position:sticky;top:0;z-index:1000;backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);background:var(--surface-translucent);border-bottom:.5px solid var(--hairline);padding-top:max(env(safe-area-inset-top),10px)}
    .nav-inner{max-width:680px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
    .large-title{font-size:clamp(22px,4vw,34px);font-weight:800;letter-spacing:-.02em}
    .segmented{background:rgba(118,118,128,.12);border-radius:12px;padding:2px;display:inline-flex}
    .segmented button{min-width:88px;padding:8px 12px;border-radius:10px;border:none;background:transparent;color:var(--secondary)}
    .segmented button[aria-pressed="true"]{background:var(--card);color:var(--tint);box-shadow:var(--shadow)}
    .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:1000;backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);background:var(--surface-translucent);border-top:.5px solid var(--hairline);padding-bottom:max(env(safe-area-inset-bottom),8px)}
    .tabbar-inner{max-width:680px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:6px 16px}
    .tabbar button{background:none;border:none;padding:8px;color:var(--secondary);border-radius:10px;min-height:44px}
    .tabbar button[aria-selected="true"]{color:var(--tint);background:rgba(14,165,233,0.12)}
    .section{max-width:680px;margin:12px auto;padding:0 16px}
    .group{background:var(--card);border-radius:14px;box-shadow:var(--shadow);border:.5px solid var(--hairline);overflow:hidden}
    .row{display:flex;align-items:center;gap:12px;padding:12px 16px;min-height:44px;line-height:1.2}
    .row + .row{border-top:.5px solid var(--separator)}
    .title-sm{font-weight:600;font-size:13px;color:var(--secondary);padding:6px 4px 8px}
    .btn{padding:10px 12px;min-height:44px;border-radius:10px;border:.5px solid var(--hairline);background:var(--card);color:var(--label)}
    .switch{appearance:none;width:52px;height:32px;border-radius:16px;background:#d1d1d6;position:relative;border:none;cursor:pointer;outline:none}
    .switch:after{content:'';position:absolute;top:2px;left:2px;width:28px;height:28px;border-radius:14px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:left .2s}
    .switch:checked{background:var(--tint)}
    .switch:checked:after{left:22px}
    .grid-7{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{aspect-ratio:1/1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:12px;border:.5px solid var(--hairline);background:var(--card);min-height:44px}
    .day.is-today{outline:2px solid var(--tint);outline-offset:-2px}
    .note{width:100%;border:.5px solid var(--hairline);border-radius:10px;padding:10px;background:var(--card);color:var(--label);min-height:80px}
    .sheet{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:flex-end;justify-content:center;z-index:2000}
    .sheet > div{width:100%;max-width:420px;background:var(--card);border-top-left-radius:18px;border-top-right-radius:18px;border:.5px solid var(--hairline);box-shadow:var(--shadow);padding-bottom:max(env(safe-area-inset-bottom),10px)}
    .grab{width:36px;height:4px;border-radius:2px;background:rgba(128,128,128,.4);margin:8px auto}
    .picker{display:block;width:100%;font-size:18px;border-radius:12px;padding:10px;border:.5px solid var(--hairline);background:var(--card);color:var(--label)}
    .player-9x16{position:relative;width:100%;max-width:420px;margin:0 auto;border-radius:12px;overflow:hidden;border:.5px solid var(--hairline);}
    .player-9x16::before{content:'';display:block;padding-top:177.777%} /* 9:16 */
    .player-9x16 > iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:0}
    /* Error overlay */
    .err-overlay{position:fixed;inset:0;background:rgba(220,38,38,.1);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:9999;display:flex;align-items:center;justify-content:center}
    .err-card{max-width:720px;margin:0 12px;background:#fff;color:#b91c1c;border:1px solid #fca5a5;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .err-card pre{margin:0;padding:16px;white-space:pre-wrap;word-break:break-word}
    @media (prefers-color-scheme: dark){.err-card{background:#1c1c1e;color:#fecaca;border-color:#7f1d1d}}
  </style>
  <script defer src="https://unpkg.com/preact@10.22.0/dist/preact.min.js"></script>
  <script defer src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
</head>
<body>
  <div id="root"></div>
  <script>
  if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('/sw.js').catch(console.error);});}
  </script>
  <script>
    const { h, render } = preact;
    const html = htm.bind(h);
    const { useState, useEffect, useRef, useMemo } = preactHooks || preact; // in case hooks are exported differently

    // --- Error boundary substitute: global error overlay
    (function(){
      function overlay(msg){
        const el=document.createElement('div'); el.className='err-overlay';
        el.innerHTML='<div class="err-card"><pre>'+msg.replace(/[<>]/g, s=>({ '<':'&lt;','>':'&gt;' }[s]))+'</pre></div>';
        document.body.appendChild(el);
      }
      window.addEventListener('error', e=>overlay(String(e.error?.stack||e.message||e)));
      window.addEventListener('unhandledrejection', e=>overlay(String(e.reason?.stack||e.reason||e)));
    })();

    // --- Helpers
    function startOfMonth(d){const x=new Date(d);x.setDate(1);x.setHours(0,0,0,0);return x;}
    function isoDate(d){return new Date(d).toISOString().slice(0,10);}
    function fmtShort(d){return new Date(d).toLocaleDateString(undefined,{day:'numeric'});}
    function nextMonth(d,n=1){const x=new Date(d);x.setMonth(x.getMonth()+n);return x;}
    const DAYS=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

    function getExerciseBaseName(label){
      if(!label) return ''; const dash=label.indexOf('‚Äî'); const hy=label.indexOf('-');
      const idx=[dash,hy].filter(i=>i>-1).sort((a,b)=>a-b)[0]; const cut=idx>-1?label.slice(0,idx):label;
      return cut.replace(/\\s+\\([^)]+\\)$/,'').trim();
    }
    function parseScheme(label){ // returns {sets: n, target: repsOrSec, time:false|true, perSide:boolean}
      const m = label.match(/(\\d+)\\s*[√óx]\\s*([0-9]+(?:‚Äì[0-9]+)?)(?:\\s*sec)?(\\/side)?/i);
      if(m){ const sets=parseInt(m[1],10); const target=m[2]; const time=/sec/i.test(label); const perSide=!!m[3]; return {sets, target, time, perSide}; }
      return {sets:3, target:'10', time:false, perSide:false};
    }
    function targetToNumber(target, time){ // for default fill
      if(!target) return time?30:10;
      if(target.includes('‚Äì')){ const [a,b]=target.split('‚Äì').map(Number); return Math.round((a+b)/2); }
      const n=Number(target); return Number.isFinite(n)? n : (time?30:10);
    }

    // Shorts -> /embed autoplay
    const EMBED=(id)=>`https://www.youtube.com/embed/${id}?autoplay=1&mute=1&playsinline=1&rel=0`;
    const VIDEO={
      "Leg press": EMBED("fpYaVKypytg"),
      "Glute bridge": EMBED("KwHhk-RLiyQ"),
      "Step-ups": EMBED("k8_XGuDcQ2E"),
      "Standing calf raises": EMBED("JTzf4IPR7dw"),
      "Pallof press": EMBED("5aZ0IhJS8O8"),
      "Superman hold": EMBED("VD6ma6oe4ZA"),
      "Chest press": EMBED("_g6bPSKIamY"),
      "Seated row": EMBED("Kh2WA2Y1M0k"),
      "Shoulder press": EMBED("e1scliIVDQo"),
      "Lat pulldown": EMBED("5s6KGLTMgoI"),
      "Dead bug": EMBED("DqLL45uk2Tk"),
      "Side plank": EMBED("BtM0a9x1F5o"),
    };

    const PROGRAM={
      Tuesday:{type:'lower',focus:'Day B (Lower + Core + Bike Intervals)',tasks:['Leg press ‚Äî 3√ó12','Glute bridge ‚Äî 3√ó12','Step-ups ‚Äî 2√ó10/leg','Standing calf raises ‚Äî 3√ó15','Pallof press ‚Äî 2√ó12/side','Superman hold ‚Äî 2√ó15 sec'],intervalsTitle:'Finisher ‚Äî 15‚Äëmin Bike Intervals',intervals:['0‚Äì3: Warm-up (60‚Äì70 RPM)','3‚Äì5: Interval 1 (80‚Äì90 RPM)','5‚Äì7: Recovery (60‚Äì70 RPM)','7‚Äì9: Interval 2 (80‚Äì90 RPM)','9‚Äì11: Recovery (60‚Äì70 RPM)','11‚Äì13: Interval 3 (85‚Äì95 RPM)','13‚Äì15: Cool down (60‚Äì70 RPM)']},
      Thursday:{type:'cardio',focus:'Cardio + Core (Bike Steady + Sprints)',tasks:['Side planks ‚Äî 2√ó30 sec/side','Dead bugs ‚Äî 2√ó10/side'],intervalsTitle:'Bike ‚Äî 20‚Äëmin steady cardio + sprints',intervals:['0‚Äì3: Warm-up (60‚Äì70 RPM)','3‚Äì15: Steady 70‚Äì80 RPM (~6/10)','15‚Äì18: Sprints 90‚Äì100 RPM (~8/10)','18‚Äì20: Cool down 60‚Äì65 RPM']},
      Saturday:{type:'upper',focus:'Day A (Upper + Core + Steady Bike)',tasks:['Chest press ‚Äî 3√ó12','Seated row ‚Äî 3√ó12','Shoulder press ‚Äî 3√ó10','Lat pulldown ‚Äî 3√ó12','Dead bug ‚Äî 2√ó10/side','Side plank ‚Äî 2√ó20‚Äì30 sec/side'],intervalsTitle:'Cardio finisher ‚Äî 15‚Äì20 min steady bike',intervals:['15‚Äì20: Steady 70‚Äì80 RPM (~6/10)']},
    };

    function InfoSheet({name,onClose}){
      const entry = Object.entries(VIDEO).find(([k])=>name.toLowerCase().includes(k.toLowerCase()));
      const url = entry? entry[1] : null;
      const title = (entry?entry[0]:name)+' Guide';
      return html`<div class="sheet" role="dialog" aria-modal="true" aria-label=${title}>
        <div>
          <div class="grab"></div>
          <div style="padding:8px 16px 12px;display:flex;align-items:center;justify-content:space-between">
            <div style="font-weight:700">${title}</div>
            <button class="btn" onClick=${onClose}>Done</button>
          </div>
          <div style="padding:0 16px 16px">
            <div class="player-9x16">
              <iframe src=${url||''} title=${title} allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>`;
    }

    function Segmented({value,onChange}){
      return html`<div class="segmented" role="tablist" aria-label="View mode">
        ${['Calendar','Today'].map(l=>{const k=l.toLowerCase(); return html`<button role="tab" aria-pressed=${value===k} aria-selected=${value===k} onClick=${()=>onChange(k)}>${l}</button>`})}
      </div>`;
    }
    function Nav({title,right}){
      return html`<div class="nav"><div class="nav-inner"><div class="large-title">${title}</div><div>${right}</div></div></div>`;
    }

    function MonthView({currentMonth,setCurrentMonth,setSelectedDate}){
      const year=currentMonth.getFullYear(), month=currentMonth.getMonth();
      const firstDay=startOfMonth(currentMonth);
      const startDay=firstDay.getDay()===0?6:firstDay.getDay()-1;
      const daysInMonth=new Date(year,month+1,0).getDate();
      const cells=[]; for(let i=0;i<startDay;i++) cells.push(null); for(let d=1; d<=daysInMonth; d++) cells.push(new Date(year,month,d));
      return html`<main><section class="section"><div class="group" style="padding:12px 12px">
        <div class="row" style="justify-content:space-between">
          <button class="btn" onClick=${()=>setCurrentMonth(nextMonth(currentMonth,-1))}>‚Üê</button>
          <div style="font-weight:700">${currentMonth.toLocaleDateString(undefined,{month:'long',year:'numeric'})}</div>
          <button class="btn" onClick=${()=>setCurrentMonth(nextMonth(currentMonth,1))}>‚Üí</button>
        </div>
        <div class="title-sm" style="padding-left:8px">Weekdays</div>
        <div class="grid-7" style="padding:4px 8px 12px">${DAYS.map(d=>html`<div style="text-align:center;color:var(--secondary);font-size:12px">${d}</div>`)}</div>
        <div class="grid-7" style="padding:0 8px 8px">
          ${cells.map((date,idx)=>{
            if(!date) return html`<div key=${idx}></div>`;
            const dayName=date.toLocaleDateString(undefined,{weekday:'long'});
            const cfg=PROGRAM[dayName];
            const raw=localStorage.getItem('tt-day:'+isoDate(date));
            const data=raw?JSON.parse(raw):{tasks:[],intervals:[],logs:[],notes:''};
            const total=cfg?(cfg.tasks.length+(cfg.intervals?.length||0)):0;
            const done=(data.tasks?.filter(Boolean).length||0)+(data.intervals?.filter(Boolean).length||0);
            const isToday=isoDate(date)===isoDate(new Date());
            return html`<button class=${'day'+(isToday?' is-today':'')} onClick=${()=>setSelectedDate(date)}>
              <div class="num">${fmtShort(date)}</div>
              <div style="font-size:18px">${cfg ? (cfg.type==='lower'?'üèãÔ∏è‚Äç‚ôÇÔ∏è': cfg.type==='upper'?'üí™': 'üö¥') : 'üí§'}</div>
              <div style="font-size:10px;color:var(--secondary)">${total>0? (done+'/'+total) : 'Rest'}</div>
            </button>`;
          })}
        </div>
      </div></section></main>`;
    }

    function buildOptions(min,max,step){const out=[]; for(let v=min; v<=max+1e-9; v+=step){const r=Math.round(v/step)*step; const val=Number(r.toFixed(step<1?1:0)); out.push(val);} return out;}
    function DetailView({selectedDate,setSelectedDate}){
      const dateISO=isoDate(selectedDate);
      const dayName=selectedDate.toLocaleDateString(undefined,{weekday:'long'});
      const cfg=PROGRAM[dayName];
      const [data,setData] = preactHooks.useState( JSON.parse(localStorage.getItem('tt-day:'+dateISO)||'{"tasks":[],"intervals":[],"logs":[],"notes":""}') );
      const [picker,setPicker] = preactHooks.useState(null);
      const [info,setInfo] = preactHooks.useState(null);
      preactHooks.useEffect(()=>{ setData(JSON.parse(localStorage.getItem('tt-day:'+dateISO)||'{"tasks":[],"intervals":[],"logs":[],"notes":""}')); },[dateISO]);
      preactHooks.useEffect(()=>{ localStorage.setItem('tt-day:'+dateISO, JSON.stringify(data)); },[dateISO,data]);

      function ensureSets(exIdx, setsCount, target, isTime){
        setData(prev=>{
          const logs = prev.logs ? [...prev.logs] : [];
          const cur = logs[exIdx] && logs[exIdx].sets ? [...logs[exIdx].sets] : [];
          // init sets to setsCount
          while(cur.length<setsCount){ cur.push({w:10, r: targetToNumber(target,isTime), done:false}); }
          if(cur.length>setsCount) cur.length = setsCount;
          logs[exIdx] = { ...(logs[exIdx]||{}), sets: cur };
          return {...prev, logs};
        });
      }
      function updateSet(exIdx,setIdx,patch){
        setData(prev=>{
          const logs=[...(prev.logs||[])];
          const entry={...(logs[exIdx]||{}), sets:[...((logs[exIdx]&&logs[exIdx].sets)||[])]};
          entry.sets[setIdx] = { ...(entry.sets[setIdx]||{w:10,r:10,done:false}), ...patch };
          logs[exIdx]=entry; return {...prev, logs};
        });
      }
      const weightOptions = useMemo(()=>buildOptions(0,200,0.5),[]);
      const repOptions = useMemo(()=>buildOptions(1,30,1),[]);
      const timeOptions = useMemo(()=>buildOptions(5,180,5),[]);

      function PickerSheet({ title, value, onChange, onClose, options, format }){
        const ref = useRef(null);
        useEffect(()=>{ const t=setTimeout(()=>{ try{ref.current && ref.current.focus({preventScroll:true}); ref.current.click();}catch(e){} },50); return ()=>clearTimeout(t); },[]);
        return html`<div class="sheet" role="dialog" aria-modal="true" aria-label=${title}>
          <div>
            <div class="grab"></div>
            <div style="display:flex;align-items:center;justify-content:space-between;padding:0 16px 8px">
              <div style="font-weight:700">${title}</div>
              <button class="btn" onClick=${onClose}>Done</button>
            </div>
            <div style="padding:0 16px 16px">
              <select ref=${ref} class="picker" value=${String(value)} onChange=${e=>onChange(Number(e.target.value))}>
                ${options.map(v=>html`<option value=${v}>${format?format(v):v}</option>`)}
              </select>
            </div>
          </div>
        </div>`;
      }

      return html`<main class="section">
        <div class="group" style="padding:12px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-size:12px;color:var(--secondary)">${selectedDate.toLocaleDateString(undefined,{weekday:'long'})}</div>
              <div style="font-weight:800;font-size:20px">${selectedDate.toLocaleDateString()}</div>
              <div style="font-size:13px;color:var(--secondary)">${cfg?cfg.focus:'Rest / Recovery'}</div>
            </div>
            <button class="btn" onClick=${()=>setSelectedDate(null)}>Back</button>
          </div>
        </div>

        ${cfg? html`
          <div class="title-sm">Exercises</div>
          <div class="group">
            ${cfg.tasks.map((t,i)=>{
              const base=getExerciseBaseName(t);
              const scheme=parseScheme(t);
              preactHooks.useEffect(()=>{ ensureSets(i, scheme.sets, scheme.target, scheme.time); }, [dateISO]);
              const entry=(data.logs&&data.logs[i])||{};
              const sets=entry.sets||[];
              const doneCount=sets.filter(s=>s&&s.done).length;
              const volume=sets.reduce((acc,s)=>acc+(s?.w||0)*(s?.r||0)*(scheme.time?0:1),0);
              return html`<div class="row" style="flex-direction:column;align-items:stretch">
                <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;width:100%">
                  <div style="font-weight:600">${base}</div>
                  <div style="font-size:12px;color:var(--secondary)">${doneCount}/${scheme.sets} done${volume?` ¬∑ Vol ${volume.toFixed(0)} kg`:''}</div>
                </div>
                ${sets.map((s,si)=>html`
                  <div class="row" style="gap:8px;padding:8px 0;border:none">
                    <input type="checkbox" class="switch" checked=${!!s?.done} onChange=${e=>updateSet(i,si,{done:e.target.checked})} aria-label=${`Done Set ${si+1}`} />
                    <div style="width:54px;font-size:12px;color:var(--secondary)">Set ${si+1}</div>
                    <button class="btn" onClick=${()=>setInfo(base)}>Guide</button>
                    <button class="btn" onClick=${()=>setPicker({field:'w',ex:i,set:si,value:Number(s?.w||10),options:weightOptions,title:'Weight (kg)',format:(v)=>v.toFixed(1)+' kg'})}>${(s?.w??10).toFixed(1)} kg</button>
                    <button class="btn" onClick=${()=>{
                      if(scheme.time){
                        setPicker({field:'r',ex:i,set:si,value:Number(s?.r||targetToNumber(scheme.target,true)),options:timeOptions,title:'Time (sec)',format:(v)=>`${v} sec`});
                      }else{
                        setPicker({field:'r',ex:i,set:si,value:Number(s?.r||targetToNumber(scheme.target,false)),options:repOptions,title:'Reps',format:(v)=>String(v)});
                      }
                    }}>${scheme.time?`${s?.r||targetToNumber(scheme.target,true)} sec`:`${s?.r||targetToNumber(scheme.target,false)} reps`}</button>
                    ${si===0? html`<button class="btn" onClick=${()=>{
                        // copy Set1 down
                        for(let k=1;k<sets.length;k++){ updateSet(i,k,{w:sets[0].w, r:sets[0].r}); }
                      }}>copy ‚Üì</button>`:''}
                  </div>
                `)}
                <div style="display:flex;gap:8px">
                  <button class="btn" onClick=${()=>updateSet(i, sets.length, {w: (sets[0]?.w??10), r: targetToNumber(scheme.target,scheme.time), done:false})}>+ Set</button>
                  ${sets.length>1? html`<button class="btn" onClick=${()=>{ setData(prev=>{const logs=[...(prev.logs||[])]; const entry={...(logs[i]||{}), sets:[...((logs[i]&&logs[i].sets)||[])]}; entry.sets.pop(); logs[i]=entry; return {...prev, logs};}); }}>‚àí Set</button>`:''}
                </div>
              </div>`;
            })}
          </div>

          ${Array.isArray(cfg.intervals)&&cfg.intervals.length>0 ? html`
            <div class="title-sm">${cfg.intervalsTitle}</div>
            <div class="group">
              ${cfg.intervals.map((t,i)=>html`
                <label class="row">
                  <input type="checkbox" class="switch" checked=${!!(data.intervals&&data.intervals[i])} onChange=${e=>{
                    setData(prev=>{const intervals=[...((prev.intervals)||[])]; intervals[i]=e.target.checked; return {...prev, intervals};});
                  }} aria-label=${'Done: '+t} />
                  <div style="font-size:14px">${t}</div>
                </label>
              `)}
            </div>
          `: ''}

          <div class="title-sm">Notes</div>
          <div class="group" style="padding:12px">
            <textarea class="note" rows="3" placeholder="How did it feel? Any back tightness?" value=${data.notes||''} onInput=${e=>setData(prev=>({...prev,notes:e.target.value}))}></textarea>
          </div>
        ` : html`<div class="group" style="padding:12px"><div style="color:var(--secondary);font-size:14px">Rest / Active recovery. Suggested: light walk, gentle mobility.</div></div>`}

        ${picker ? html`<div class="sheet" role="dialog" aria-modal="true" aria-label=${picker.title}>
          <div>
            <div class="grab"></div>
            <div style="display:flex;align-items:center;justify-content:space-between;padding:0 16px 8px">
              <div style="font-weight:700">${picker.title}</div>
              <button class="btn" onClick=${()=>setPicker(null)}>Done</button>
            </div>
            <div style="padding:0 16px 16px">
              <select class="picker" value=${String(picker.value)} onChange=${e=>{
                const val = Number(e.target.value);
                setPicker(p=>({...p,value:val}));
                updateSet(picker.ex,picker.set,{ [picker.field]: val });
              }}>
                ${picker.options.map(v=>html`<option value=${v}>${picker.format?picker.format(v):v}</option>`)}
              </select>
            </div>
          </div>
        </div>` : ''}

        ${info ? html`<${InfoSheet} name=${info} onClose=${()=>setInfo(null)}/>` : ''}
      </main>`;
    }

    function App(){
      const [mode,setMode] = preactHooks.useState('calendar');
      const [selectedDate,setSelectedDate] = preactHooks.useState(null);
      const [currentMonth,setCurrentMonth] = preactHooks.useState(startOfMonth(new Date()));
      const handleModeChange=(k)=>{ setMode(k); if(k==='today') setSelectedDate(new Date()); else if(k==='calendar') setSelectedDate(null); };
      return html`
        <${Nav} title=${selectedDate?'Workout':'Training'} right=${html`<${Segmented} value=${mode} onChange=${handleModeChange}/>`} />
        ${!selectedDate ? html`<${MonthView} currentMonth=${currentMonth} setCurrentMonth=${setCurrentMonth} setSelectedDate=${setSelectedDate}/>`
                         : html`<${DetailView} selectedDate=${selectedDate} setSelectedDate=${setSelectedDate}/>`}
        <nav class="tabbar"><div class="tabbar-inner">
          <button aria-selected=${mode==='calendar'} onClick=${()=>handleModeChange('calendar')}><div style="font-size:18px">üìÜ</div><div style="font-size:11px">Calendar</div></button>
          <button aria-selected=${mode==='today'} onClick=${()=>handleModeChange('today')}><div style="font-size:18px">‚úÖ</div><div style="font-size:11px">Today</div></button>
        </div></nav>
      `;
    }

    // Preact hooks shim (older UMDs don't export hooks as preactHooks)
    const preactHooks = (function(){
      try { return preact.hooks || preact; } catch(e){ return preact; }
    })();

    render(html`<${App}/>`, document.getElementById('root'));
  </script>
</body>
</html>
